<!doctype html><html lang=en-us><head><link rel=preconnect href=https://fonts.googleapis.com><link rel=dns-prefetch href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com><link rel=dns-prefetch href=https://fonts.gstatic.com><link rel=preconnect href=https://cdnjs.cloudflare.com><link rel=dns-prefetch href=https://cdnjs.cloudflare.com><link rel=preconnect href=https://www.googletagmanager.com><link rel=dns-prefetch href=https://www.googletagmanager.com><link rel=dns-prefetch href=https://cdn.jsdelivr.net><link rel=preconnect href=https://cdn.jsdelivr.net><meta charset=utf-8><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Deploying OTA Connect | Foundries.io</title><link rel="shortcut icon" href=https://foundries.io//images/icons/favicon.ico><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lato:300,400,500,700,900"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css integrity="sha256-HtCCUh9Hkh//8U1OwcbD8epVEUdBvuI8wj1KtqMhNkI=" crossorigin=anonymous><link rel=stylesheet href=/css/foundation.min.228f9b8bdf4aae06e794eb13011f0858c2d27f9d39a55e09bbe84ff4bc8644c4.css><link rel=stylesheet href=/style.insights.bundle.min.e00d4f2b3479f7d40e61e05ea2e31fe0205674115b3a20a97df2c88ca838856a.css><link rel=stylesheet href=/css/slicknav.min.css><link rel=stylesheet type=text/css href=https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css></head><body><div class="top sticky"><div class=row><div class="small-12 large-3 medium-3 columns"><div class=logo><a href=/><img src=https://foundries.io/images/logo.png alt="Foundries.io logo"></a></div></div><div class="small-12 large-9 medium-9 columns"><nav class=desktop-menu><ul class=sf-menu id=navigation><li><a href=https://foundries.io/company/>ABOUT</a><ul class=nav-menu><li><a href=https://foundries.io/company/>COMPANY</a></li><li><a href=https://foundries.io/careers/>CAREERS</a></li></ul></li><li><a href=https://foundries.io/insights/>INSIGHTS</a><ul class=nav-menu><li><a href=https://foundries.io/insights/>BLOG</a></li><li><a href=https://foundries.io/categories/news-and-media/>NEWS</a></li><li><a href=https://foundries.io/categories/updates/>UPDATES</a></li><li><a href=https://foundries.io/faq/>FAQ</a></li></ul></li><li><a href=https://foundries.io/partners/>PARTNERS</a><ul class=nav-menu><li><a href=https://foundries.io/partners/>PARTNER PROGRAM</a></li><li><a href=https://foundries.io/partners/all/>OUR PARTNERS</a></li></ul></li><li><a href=https://foundries.io/products/>PRODUCTS</a><ul class=nav-menu><li><a href=https://foundries.io/products/>FACTORY</a></li><li><a href=https://foundries.io/pricing/>PRICING</a></li><li><a href=https://foundries.io/hardware/>HARDWARE</a></li><li><a href=https://foundries.io/terms/>TERMS &amp; CONDITIONS</a></li></ul></li><li><a href="https://app.foundries.io/login/?next=/"><i class="fa fa-cloud-upload"></i>&nbsp;ENGAGE</a><ul class=nav-menu><li><a href=https://app.foundries.io/docs/>DOCUMENTATION</a></li><li><a href="https://app.foundries.io/login/?next=/">DASHBOARD</a></li><li><a href=https://support.foundries.io>SUPPORT</a></li><li><a href=https://join.slack.com/t/foundriesio/shared_invite/enQtNTc5NDkxNTI5NTExLWQ1Yjc3NDA2MjI3NzA3YzkxYjEzNzlhZjQ0M2QxYTIzYmIzZjlmOThmZGU0NTk5MWEwZGIwMTU2YWE4N2I5NWQ>SLACK</a></li><li><a href=https://app.foundries.io>START YOUR FACTORY</a></li></ul></li></ul></nav></div></div></div><header class=alt-6><div class=message><div class=row><div class="small-12 columns"><div class=message-intro><span class=message-line></span><p>FOUNDRIES.IO INSIGHTS</p><span class=message-line></span></div><h1>Deploying OTA Connect</h1><p class="text-muted text-uppercase mb-small text-right color-white">By Andy Doan&nbsp;|
June 27, 2018</p></div></div></div></header><div id=content><div class=container><div class=row><div class="small-12 columns" id=insights-post><div id=post-content><p>Continuing with the OTA blog series <a href=https://foundries.io/insights/2018/05/25/ota-part-1/>part one</a> and <a href=https://foundries.io/insights/2018/06/14/ota-part-2/>part two</a>, this article shows you how to deploy OTA Connect using the OTA Community Edition into Google&rsquo;s Kubernetes Engine (GKE). After completion of these instructions, you&rsquo;ll have an OTA Connect server available on the internet with a single QEMU device registered to it.</p><h3 id=requirements>Requirements</h3><p>You&rsquo;ll need a few things in place to be able to deploy this to GKE:</p><ul><li>An account with the <a href=https://console.cloud.google.com>Google Cloud Platform</a> (GCP).</li><li>A Project defined in your GCP account.</li><li>Git and Docker to run the deployment scripts.</li></ul><p>It&rsquo;s also highly recommended that you are able to add DNS records to a domain you own. Otherwise, you&rsquo;ll have to edit /etc/hosts to access the services.</p><h3 id=overview>Overview</h3><p>OTA Community Edition deploys several <a href=https://foundries.io/insights/2018/06/14/ota-part-2/>micro-services</a> to Kubernetes. However, it doesn&rsquo;t come with any built-in security. The approach taken by this article is to expose the unsafe services via a single nginx reverse-proxy. This will make it obvious what services need to be locked down. Part four of the blog series will describe an approach for securing the reverse-proxy. When the deployment is completed, you&rsquo;ll have a system with these caveats:</p><ul><li><strong>INSECURE</strong> - Anyone can push to the TreeHub</li><li><strong>INSECURE</strong> - Anyone can access and manage devices via the web application</li></ul><p>Part 4 of the blog series will go into the details of securing everything.</p><h3 id=one-time-only-steps>One-Time Only Steps</h3><p>First get the OTA Community Edition source. This article relies on 3 out-of-tree patches to streamline the process:</p><pre><code>  git clone -b ota-blog-part3 https://github.com/foundriesio/ota-community-edition
  cd ota-community-edition

  # If you are curious about the out-of-tree patches:
  git log -3
</code></pre><p>OTA Community Edition has several dependencies that aren&rsquo;t easy to install. This article uses a container provided by the project to make things easier. If you have the tools installed locally you can always skip this step and call things like <code>kubectl</code> and <code>gcloud</code> directly.</p><pre><code>  # Build the container:
  ./contrib/gke/docker-build.sh
</code></pre><p>With the container in place, you need to configure the <code>gcloud</code> tools to use your GCP project:</p><pre><code>  EXTRA_ARGS=&quot;-it&quot; ./contrib/gke/gcloud auth login
  ./contrib/gke/gcloud config set project &lt;YOUR PROJECT&gt;
  # You can use any GCP region you wish below
  ./contrib/gke/gcloud config set compute/zone us-central1-c
</code></pre><h3 id=deploy-ota-connect>Deploy OTA Connect</h3><p>The ota-blog-part3 branch of OTA Community Edition includes a helper script to deploy OTA Connect. The script isn&rsquo;t very long and is worth taking a close look at to understand the mechanics of deploying OTA Connect. Deploying is as simple as:</p><pre><code>  ./create-cluster.sh example.com
</code></pre><h3 id=set-up-dns>Set up DNS</h3><p>You now need DNS entries in place to access the OTA server. Add the following entries into your DNS management tool:</p><pre><code> # Get the IP of the nginx reverse-proxy:
 ./contrib/gke/kubectl get svc reverse-proxy

 # Point these entries at the reverse-proxy IP:
 tuf-reposerver.&lt;DNS_NAME&gt;, treehub.&lt;DNS_NAME&gt;, app.&lt;DNS_NAME&gt;

 # Get the IP of the device gateway:
 ./contrib/gke/kubectl get svc gateway-service
 # Point &lt;SERVER_NAME&gt; at this IP
</code></pre><p>If you don&rsquo;t have real DNS in place, you can hack your /etc/hosts with something like:</p><pre><code>  # A quick entry generator for /etc/hosts:
 echo $(./contrib/gke/kubectl get svc reverse-proxy -o json | jq -r '.status.loadBalancer.ingress[0].ip')    treehub.&lt;DNS_NAME&gt; tuf-reposerver.&lt;DNS_NAME&gt;  app.&lt;DNS_NAME&gt;
</code></pre><p>As a sanity check, you can validate everything is working with:</p><pre><code>  curl http://tuf-reposerver.&lt;DNS_NAME&gt;/api/v1/user_repo/targets.json
  curl http://treehub.&lt;DNS_NAME&gt;/api/v3/config
</code></pre><h3 id=secure-the-tuf-keys>Secure the TUF Keys</h3><p>OTA Connect is running and exposed to the internet. The nginx reverse-proxy has no built-in security and the TUF private keys are available to <strong>anyone</strong>. This can be fixed even though the reverse-proxy has no authentication/authorization logic. In fact, it&rsquo;s a great example of how TUF protects you from the leaking of a private key. The ota-blog-part3 branch includes a script to make it easy:</p><pre><code>  ./rotate-keys.sh example.com
</code></pre><h3 id=upload-an-image>Upload an Image</h3><p>Uploading an image is a great way to validate the server is working and will be needed when you register a device:</p><pre><code>  wget https://api.foundries.io/projects/lmp/builds/527/runs/other-intel-corei7-64/other/intel-corei7-64-ostree_repo.tar.bz2
  # if you hacked /etc/hosts then include &quot;--network host&quot;
  docker run --rm -it -v $PWD:/build --workdir=/build opensourcefoundries/aktualizr \
    ota-publish -m intel-corei7-64  -c ./generated/ota-ce.example.com/credentials.zip -r ./intel-corei7-64-ostree_repo.tar.bz2
</code></pre><h3 id=register-a-device>Register a Device</h3><p>OTA Connect requires <a href=https://github.com/advancedtelematic/aktualizr/blob/master/docs/implicit-provisioning.adoc>implicit provisioning</a>. Creating a device is fairly easy:</p><pre><code>  # DEVICE_ID = The name of the device to appear in OTA Community Edition
  # SERVER_NAME = Your gateway server. eg SERVER_NAME=ota-ce.example.com
  ./contrib/gke/make SERVER_NAME=&lt;SERVER_NAME&gt; DEVICE_ID=&lt;DEVICE_ID&gt; SKIP_CLIENT=true new-client
</code></pre><p>Configuring your device is fairly simple. Remote access, however, isn&rsquo;t
always the same. Here are the files you&rsquo;ll need to copy to your device:</p><ul><li>generated/<code>&lt;SERVER_NAME&gt;</code>/server_ca.pem to /var/sota/root.crt</li><li>generated/<code>&lt;SERVER_NAME&gt;</code>/devices/<code>&lt;DEVICE_ID&gt;</code>/client.pem /var/sota/client.pem</li><li>generated/<code>&lt;SERVER_NAME&gt;</code>/devices/<code>&lt;DEVICE_ID&gt;</code>/pkey.pem /var/sota/pkey.pem</li></ul><p>If you haven&rsquo;t set up DNS entries, you&rsquo;ll need to add a line to
/etc/hosts on the target device. The public IP comes from the gateway-service:</p><pre><code>  ./contrib/gke/kubectl get svc gateway-service -o json \
    | jq -r '.status.loadBalancer.ingress[0].ip'

  # /etc/hosts on target would get something like:
  ota-ce.example.com &lt;ip-from-comand-above&gt;
</code></pre><p>Finally create a /var/sota/sota.toml on your target device:</p><pre><code># /var/sota/sota.toml
[tls]
server = &quot;https://ota-ce.example.com:8443&quot;
ca_source = &quot;file&quot;
pkey_source = &quot;file&quot;
cert_source = &quot;file&quot;

[provision]
server = &quot;https://ota-ce.example.com:8443&quot;
p12_password = &quot;&quot;
expiry_days = &quot;36000&quot;
provision_path = &quot;&quot;
primary_ecu_hardware_id = &quot;intel-corei7-64&quot;

[uptane]
polling = true
# NOTE - this might need to change depending on your CPU
primary_ecu_hardware_id = &quot;intel-corei7-64&quot;
director_server = &quot;https://ota-ce.example.com:8443/director&quot;
repo_server = &quot;https://ota-ce.example.com:8443/repo&quot;
key_source = &quot;file&quot;

[pacman]
type = &quot;ostree&quot;
ostree_server = &quot;https://ota-ce.example.com:8443/treehub&quot;
packages_file = &quot;/usr/package.manifest&quot;

[storage]
type = &quot;sqlite&quot;
path = &quot;/var/sota/&quot;

[import]
tls_cacert_path = &quot;/var/sota/root.crt&quot;
tls_pkey_path = &quot;/var/sota/pkey.pem&quot;
tls_clientcert_path = &quot;/var/sota/client.pem&quot;

</code></pre></div><div id=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"foundriesio"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div><div class=row><div class="small-12 columns"><div class=post-categories><div class="panel panel-default sidebar-menu"><div class=panel-heading><h3 class=panel-title>Categories</h3></div><div class=panel-body><ul class="nav nav-pills nav-stacked"><li><a href=https://foundries.io/categories/blockchain>blockchain (1)</a></li><li><a href=https://foundries.io/categories/conferences>conferences (4)</a></li><li><a href=https://foundries.io/categories/demos>demos (4)</a></li><li><a href=https://foundries.io/categories/fota>fota (15)</a></li><li><a href=https://foundries.io/categories/foundriesfactory>foundriesfactory (1)</a></li><li><a href=https://foundries.io/categories/iot>iot (1)</a></li><li><a href=https://foundries.io/categories/lmp>lmp (6)</a></li><li><a href=https://foundries.io/categories/microplatform>microplatform (8)</a></li><li><a href=https://foundries.io/categories/news-and-media>news-and-media (14)</a></li><li><a href=https://foundries.io/categories/security>security (1)</a></li><li><a href=https://foundries.io/categories/toradex>toradex (1)</a></li><li><a href=https://foundries.io/categories/updates>updates (74)</a></li><li><a href=https://foundries.io/categories/zephyr-mp>zephyr-mp (2)</a></li><li><a href=https://foundries.io/categories/zephyr-news>zephyr-news (16)</a></li></ul></div></div><div class="panel sidebar-menu"><div class=panel-heading><h3 class=panel-title>Tags</h3></div><div class=panel-body><ul class=tag-cloud><li><a href=https://foundries.io/tags/ai><i class="fa fa-tags"></i>ai</a></li><li><a href=https://foundries.io/tags/assistant><i class="fa fa-tags"></i>assistant</a></li><li><a href=https://foundries.io/tags/att><i class="fa fa-tags"></i>att</a></li><li><a href=https://foundries.io/tags/balena><i class="fa fa-tags"></i>balena</a></li><li><a href=https://foundries.io/tags/ble><i class="fa fa-tags"></i>ble</a></li><li><a href=https://foundries.io/tags/blockchain><i class="fa fa-tags"></i>blockchain</a></li><li><a href=https://foundries.io/tags/bugs><i class="fa fa-tags"></i>bugs</a></li><li><a href=https://foundries.io/tags/container><i class="fa fa-tags"></i>container</a></li><li><a href=https://foundries.io/tags/containers><i class="fa fa-tags"></i>containers</a></li><li><a href=https://foundries.io/tags/crypto><i class="fa fa-tags"></i>crypto</a></li><li><a href=https://foundries.io/tags/cve><i class="fa fa-tags"></i>cve</a></li><li><a href=https://foundries.io/tags/decentralized><i class="fa fa-tags"></i>decentralized</a></li><li><a href=https://foundries.io/tags/demos><i class="fa fa-tags"></i>demos</a></li><li><a href=https://foundries.io/tags/docker><i class="fa fa-tags"></i>docker</a></li><li><a href=https://foundries.io/tags/docker-apps><i class="fa fa-tags"></i>docker-apps</a></li><li><a href=https://foundries.io/tags/docker-compose><i class="fa fa-tags"></i>docker-compose</a></li><li><a href=https://foundries.io/tags/edge><i class="fa fa-tags"></i>edge</a></li><li><a href=https://foundries.io/tags/embedded><i class="fa fa-tags"></i>embedded</a></li><li><a href=https://foundries.io/tags/fota><i class="fa fa-tags"></i>fota</a></li><li><a href=https://foundries.io/tags/foundries.io><i class="fa fa-tags"></i>foundries.io</a></li><li><a href=https://foundries.io/tags/foundriesfactory><i class="fa fa-tags"></i>foundriesfactory</a></li><li><a href=https://foundries.io/tags/google><i class="fa fa-tags"></i>google</a></li><li><a href=https://foundries.io/tags/iot><i class="fa fa-tags"></i>iot</a></li><li><a href=https://foundries.io/tags/k8s><i class="fa fa-tags"></i>k8s</a></li><li><a href=https://foundries.io/tags/kernel><i class="fa fa-tags"></i>kernel</a></li><li><a href=https://foundries.io/tags/keys><i class="fa fa-tags"></i>keys</a></li><li><a href=https://foundries.io/tags/kubernetes><i class="fa fa-tags"></i>kubernetes</a></li><li><a href=https://foundries.io/tags/linux><i class="fa fa-tags"></i>linux</a></li><li><a href=https://foundries.io/tags/lmp><i class="fa fa-tags"></i>lmp</a></li><li><a href=https://foundries.io/tags/lte><i class="fa fa-tags"></i>lte</a></li><li><a href=https://foundries.io/tags/lts><i class="fa fa-tags"></i>lts</a></li><li><a href=https://foundries.io/tags/lwm2m><i class="fa fa-tags"></i>lwm2m</a></li><li><a href=https://foundries.io/tags/management><i class="fa fa-tags"></i>management</a></li><li><a href=https://foundries.io/tags/mcuboot><i class="fa fa-tags"></i>mcuboot</a></li><li><a href=https://foundries.io/tags/media><i class="fa fa-tags"></i>media</a></li><li><a href=https://foundries.io/tags/microplatform><i class="fa fa-tags"></i>microplatform</a></li><li><a href=https://foundries.io/tags/open-source><i class="fa fa-tags"></i>open-source</a></li><li><a href=https://foundries.io/tags/ota><i class="fa fa-tags"></i>ota</a></li><li><a href=https://foundries.io/tags/portainer><i class="fa fa-tags"></i>portainer</a></li><li><a href=https://foundries.io/tags/press><i class="fa fa-tags"></i>press</a></li><li><a href=https://foundries.io/tags/radio><i class="fa fa-tags"></i>radio</a></li><li><a href=https://foundries.io/tags/raspberry-pi><i class="fa fa-tags"></i>raspberry-pi</a></li><li><a href=https://foundries.io/tags/raspberry-pi-4><i class="fa fa-tags"></i>raspberry-pi-4</a></li><li><a href=https://foundries.io/tags/robot><i class="fa fa-tags"></i>robot</a></li><li><a href=https://foundries.io/tags/secure><i class="fa fa-tags"></i>secure</a></li><li><a href=https://foundries.io/tags/security><i class="fa fa-tags"></i>security</a></li><li><a href=https://foundries.io/tags/toradex><i class="fa fa-tags"></i>toradex</a></li><li><a href=https://foundries.io/tags/update><i class="fa fa-tags"></i>update</a></li><li><a href=https://foundries.io/tags/whitepaper><i class="fa fa-tags"></i>whitepaper</a></li><li><a href=https://foundries.io/tags/zephyr><i class="fa fa-tags"></i>zephyr</a></li><li><a href=https://foundries.io/tags/zmp><i class="fa fa-tags"></i>zmp</a></li></ul></div></div></div></div></div></div></div><footer><div class="row footerlinks"><div class="columns small-12 medium-6 border-right"><h2>Company</h2><ul><li><a href=https://foundries.io/company/>About</a></li><li><a href=https://foundries.io/careers/>Careers</a></li><li><a href=https://support.foundries.io/>Support</a></li><li><a href=https://status.foundries.io/>System status</a></li><li><a href=https://foundries.io/privacy/>Privacy</a></li><li><a href=https://foundries.io/terms/>Terms</a></li></ul></div><div class="columns small-12 medium-6"><h2>Connect</h2><ul class=social-links><li><a href=https://twitter.com/foundriesio><i class="fa fa-twitter fa-2x"></i></a></li><li><a href=https://www.linkedin.com/company/foundriesio/><i class="fa fa-linkedin fa-2x"></i></a></li><li><a href=https://github.com/foundriesio><i class="fa fa-github fa-2x"></i></a></li><li><a href=https://join.slack.com/t/foundriesio/shared_invite/enQtNTc5NDkxNTI5NTExLWQ1Yjc3NDA2MjI3NzA3YzkxYjEzNzlhZjQ0M2QxYTIzYmIzZjlmOThmZGU0NTk5MWEwZGIwMTU2YWE4N2I5NWQ><i class="fa fa-slack fa-2x"></i></a></li></ul></div></div><p class=copyright>Copyright 2018 &ndash; 2020 Foundries.io All rights reserved</p></footer><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-111281311-1','auto');ga('send','pageview');}</script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin=anonymous></script><script src=https://foundries.io//js/vendor/wow.min.js></script><script src=https://foundries.io//js/vendor/what-input.min.js></script><script src=https://foundries.io//js/vendor/hoverIntent.js></script><script src=https://foundries.io//js/vendor/jquery.responsiveTabs.js></script><script src=https://foundries.io//js/vendor/superfish.min.js></script><script src=https://foundries.io//js/vendor/owl.carousel.min.js></script><script src=https://foundries.io//js/vendor/foundation.min.js></script><script src=https://foundries.io//js/vendor/jquery.slicknav.min.js></script><script src=/js/custom.min.js></script><script src=https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js></script><script>window.cookieconsent.initialise({"cookie":{"name":"fio_consent","domain":".foundries.io","secure":false},"palette":{"popup":{"background":"#37485c"},"button":{"background":"#14a7d0"}},"position":"bottom-right","content":{"header":'Cookies used on this website!',"target":"_blank","link":false,"message":"This website uses cookies to enable us to improve your experience, as explained in our Privacy Policy.<br><br>By using this website you agree to our <a class='cc-link' target='_blank' href='https://foundries.io/terms#website'>Terms and Conditions</a> and to our <a class='cc-link' taget='_blank' href='https://foundries.io/privacy/'>Privacy Policy</a>","href":"https://foundries.io/privacy/"}});</script></body></html>