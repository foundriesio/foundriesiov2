<!doctype html><html class=no-js lang=en-us><head><link rel=preconnect href=https://cdnjs.cloudflare.com><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com><link rel=preconnect href=https://www.googletagmanager.com><meta charset=utf-8><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Update an embedded device with LwM2M | Foundries.io</title><link rel="shortcut icon" href=/images/icons/favicon.ico><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lato:300,400,500,700,900"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.7.0/animate.min.css integrity="sha256-HtCCUh9Hkh//8U1OwcbD8epVEUdBvuI8wj1KtqMhNkI=" crossorigin=anonymous><link rel=stylesheet href=/css/foundation.min.228f9b8bdf4aae06e794eb13011f0858c2d27f9d39a55e09bbe84ff4bc8644c4.css><link rel=stylesheet href=/style.insights.bundle.min.2aa35451f18591646da184328275dd008b2d31d8a9f140046184870b6fa8c1f4.css></head><body><div class="top sticky"><div class=row><div class="small-12 large-3 medium-3 columns"><div class=logo><a href=/><img src=/images/logo.png alt="Foundries.io logo"></a></div></div><div class="small-12 large-9 medium-9 columns"><nav class=desktop-menu><ul class=sf-menu id=navigation><li><a href=/company/>ABOUT</a><ul class=nav-menu><li><a href=/company/>COMPANY</a></li><li><a href=/labs/>LABS</a></li><li><a href=/careers/>CAREERS</a></li></ul></li><li><a href=/insights/>INSIGHTS</a><ul class=nav-menu><li><a href=/insights/>BLOG</a></li><li><a href=/categories/news-and-media/>NEWS</a></li><li><a href=/categories/updates/>UPDATES</a></li></ul></li><li><a href=/partners/>PARTNERS</a><ul class=nav-menu><li><a href=/partners/>PARTNER PROGRAM</a></li><li><a href=/partners/all/>OUR PARTNERS</a></li></ul></li><li><a href=/products/>PRODUCTS</a><ul class=nav-menu><li><a href=/products/>MICROPLATFORMS</a></li><li><a href=/pricing/>PRICING</a></li><li><a href=/hardware/>HARDWARE</a></li><li><a href=/terms/>TERMS &amp; CONDITIONS</a></li></ul></li><li><a href="https://app.foundries.io/login/?next=/"><i class="fa fa-cloud-upload"></i>&nbsp;ENGAGE</a><ul class=nav-menu><li><a href=https://app.foundries.io/docs/>DOCUMENTATION</a></li><li><a href="https://app.foundries.io/login/?next=/">DASHBOARD</a></li><li><a href=https://forums.foundries.io>FORUMS</a></li><li><a href=https://support.foundries.io>SUPPORT</a></li><li><a href=https://join.slack.com/t/foundriesio/shared_invite/enQtNTc5NDkxNTI5NTExLTU1YzI3YWFmZTI3ZjRjOTExZDZjYWFmMDNjZDBjYjczYTYzZWE0ZWYxYWVjMGZhYjNjN2MyMDVhMzY5NWNlNDE>SLACK</a></li><li><a href="https://app.foundries.io/login/?next=/">GET STARTED</a></li></ul></li></ul></nav></div></div></div><header class=alt-6><div class=message><div class=row><div class="small-12 columns"><div class=message-intro><span class=message-line></span><p>FOUNDRIES.IO INSIGHTS</p><span class=message-line></span></div><h1>Update an embedded device with LwM2M</h1><p class="text-muted text-uppercase mb-small text-right color-white">January 17, 2018</p></div></div></div></header><div id=content><div class=container><div class=row><div class="small-12 columns" id=insights-post><div id=post-content><p><a href=http://openmobilealliance.org/iot/lightweight-m2m-lwm2m>OMA Lightweight M2M</a> (LWM2M) offers a firmware object interface for directing client devices to download and apply firmware updates. Using the Zephyr microPlaform and Eclipse&rsquo;s <a href=https://www.eclipse.org/leshan/>Leshan Demo Server</a>, this seemingly complex process can be demonstrated in a few easy steps.</p><p>To illustrate how a firmware update is delivered via LwM2M, you will make a small change to the Zephyr microPlatform (ZMP) LwM2M sample project which disables the Light Control object. When flashed to an embedded device, the Leshan UI will be missing the &ldquo;Light Control&rdquo; portion near the bottom of the client detail page. Once this &ldquo;bug&rdquo; is found, you will fix the LwM2M sample, recompile and deliver your updated firmware as an over the air (OTA) update. The new firmware can be confirmed by locating the &ldquo;Light Control&rdquo; object in the Leshan UI.</p><h2 id=hardware-requirements>Hardware Requirements</h2><ul><li>Redbear Labs Nano v2 (nRF52) connected to your developer host machine.</li><li>A device running the Linux microPlatform (LMP) to be configured as an LwM2M gateway.</li></ul><h2 id=software-requirements>Software Requirements</h2><p>Before you begin, <a href=https://app.foundries.io/docs/latest/tutorial/index.html>set up the LWM2M system described in the microPlatforms Getting Started Tutorial</a>. (These instructions were tested with the 0.7 public release of the microPlatforms; the LWM2M instructions may move in future versions.)</p><h2 id=initial-setup-of-the-lwm2m-client-device>Initial setup of the LwM2M client device</h2><p><strong>Create a &ldquo;bug&rdquo; in the Zephyr microPlatform LwM2M sample</strong></p><p>From the base directory of the Zephyr microPlatform, the LwM2M sample source code is located at: zephyr-fota-samples/dm-lwm2m. Make the following changes to disable instance 0 of the &ldquo;Light Control&rdquo; object:</p><pre><code>diff --git a/prj.conf b/prj.conf
index 48abe3c..f19d284 100644
--- a/prj.conf
+++ b/prj.conf
@@ -47,7 +47,7 @@ CONFIG_LWM2M_COAP_BLOCK_SIZE=256
 CONFIG_LWM2M_FIRMWARE_UPDATE_PULL_COAP_PROXY_SUPPORT=y
 CONFIG_LWM2M_IPSO_SUPPORT=y
 CONFIG_LWM2M_IPSO_TEMP_SENSOR=y
-CONFIG_LWM2M_IPSO_LIGHT_CONTROL=y
+# CONFIG_LWM2M_IPSO_LIGHT_CONTROL is not set
 CONFIG_SYS_LOG_LWM2M_LEVEL=3

 # Logging
</code></pre><p><strong>Build and flash the sample to the BLE Nano 2</strong></p><p>Use the following commands from the base directory of the ZMP:</p><pre><code>./zmp build --board nrf52_blenano2 zephyr-fota-samples/dm-lwm2m
./zmp flash --board nrf52_blenano2 zephyr-fota-samples/dm-lwm2m
</code></pre><p><strong>Confirm that Leshan UI displays your connected device</strong></p><p>Open your own Leshan Demo Server instance in a web browser using the following URL: <a href=http://localhost:8081>http://localhost:8081</a></p><p>Find the BLE Nano 2 under the &ldquo;Client Endpoint&rdquo; list. The endpoint is generated semi-randomly using unique data from the device to ensure that each endpoint name is unique.</p><p><img src=../../../../../img/blog/leshan-client-list.png alt="Leshan Demo Server client list"></p><p>Click on it to view all of the available LwM2M objects. You should be able to confirm that &ldquo;Light Control&rdquo; object is not present at the bottom of the list.</p><p><img src=../../../../../img/blog/leshan-light-control-no-instance.png alt="Leshan Demo Server client detail: Light Control w/o instance0"></p><h2 id=fix-the-bug-and-deploy-an-ota-update>Fix the &ldquo;bug&rdquo; and deploy an OTA update</h2><p><strong>Re-enable &ldquo;Light Control&rdquo;</strong></p><pre><code>diff --git a/prj.conf b/prj.conf
index 48abe3c..f19d284 100644
--- a/prj.conf
+++ b/prj.conf
@@ -47,7 +47,7 @@ CONFIG_LWM2M_COAP_BLOCK_SIZE=256
 CONFIG_LWM2M_FIRMWARE_UPDATE_PULL_COAP_PROXY_SUPPORT=y
 CONFIG_LWM2M_IPSO_SUPPORT=y
 CONFIG_LWM2M_IPSO_TEMP_SENSOR=y
-# CONFIG_LWM2M_IPSO_LIGHT_CONTROL is not set
+CONFIG_LWM2M_IPSO_LIGHT_CONTROL=y
 CONFIG_SYS_LOG_LWM2M_LEVEL=3

 # Logging
</code></pre><p><strong>Rebuild the LwM2M sample</strong></p><pre><code>./zmp build --board nrf52_blenano2 zephyr-fota-samples/dm-lwm2m
</code></pre><p><strong>Start an HTTP server to host the new firmware</strong></p><p>Start a docker contained HTTP server to host the new firmware binary from the base of the Zephyr microPlatform.</p><pre><code>docker run -dit -p 8003:80 -v $(pwd):/usr/share/nginx/html --name nginx opensourcefoundries/nginx:latest
</code></pre><p>You can use a web browser to confirm the following url will download the new firmware:
http://{developer host IP}:8003/outdir/zephyr-fota-samples/dm-lwm2m/nrf52_blenano2/app/zephyr/dm-lwm2m-nrf52_blenano2-signed.bin</p><p>NOTE: Be sure to use your local IP address and not &ldquo;localhost&rdquo; as this URL will be used on the embedded device.</p><p><strong>Use Leshan UI to trigger a firmware download</strong></p><p>Open your own Leshan Demo Server instance in a web browser using the following URL: <a href=http://localhost:8081>http://localhost:8081</a></p><p>Look for the BLE Nano 2 client endpoint and click on it. Under the &ldquo;Firmware Update&rdquo; section do the following:</p><ul><li>Click on the &ldquo;Write&rdquo; button next to &ldquo;Package URI&rdquo;</li><li>Paste the above firmware URI as the &ldquo;Value&rdquo;</li><li>Click &ldquo;Update&rdquo;</li></ul><p><img src=../../../../../img/blog/leshan-firmware-update-package-url.png alt="Leshan Demo Server client detail: Firmware Update"></p><p><img src=../../../../../img/blog/leshan-firmware-update-package-url-value.png alt="Leshan Demo Server client detail: Firmware Update w/ URL"></p><p>If you can monitor the UART output of the BLE Nano 2, you should notice that the firmware is now being downloaded.</p><p>Instead of using UART, you can use Leshan UI to watch the &ldquo;State&rdquo; field of the &ldquo;Firmware Update&rdquo; object by clicking on it&rsquo;s &ldquo;Observe&rdquo; button. During the download, this should be a value of 1, and once complete, the value should change to 2. Any other value indicates a problem downloading the firmware.</p><p><img src=../../../../../img/blog/leshan-firmware-update-observe.png alt="Leshan Demo Server client detail: Firmware Update observe Status"></p><p><strong>Trigger the firmware update</strong></p><p>Once the &ldquo;Status&rdquo; shows a value of 2 (or you&rsquo;ve reached 100% by watching the UART log), you can tell the device to apply the update by clicking on the &ldquo;Exec&rdquo; button next to the &ldquo;Update&rdquo; resource. In Leshan, the device&rsquo;s detail page may be reloaded briefly while the device reboots and reconnects.</p><p>Once reloaded, you should notice that the &ldquo;Light Control&rdquo; block is now back at the bottom of the page.</p><p><img src=../../../../../img/blog/leshan-light-control-instance0.png alt="Leshan Demo Server client detail: Light Control w/ instance0"></p><p>Your update is now complete.</p></div><div id=comments><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"foundriesio"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div><div class=row><div class="small-12 columns"><div class=post-categories><div class="panel panel-default sidebar-menu"><div class=panel-heading><h3 class=panel-title>Categories</h3></div><div class=panel-body><ul class="nav nav-pills nav-stacked"><li><a href=https://foundries.io/categories/blockchain>blockchain (1)</a></li><li><a href=https://foundries.io/categories/conferences>conferences (4)</a></li><li><a href=https://foundries.io/categories/demos>demos (1)</a></li><li><a href=https://foundries.io/categories/fota>fota (8)</a></li><li><a href=https://foundries.io/categories/microplatform>microplatform (7)</a></li><li><a href=https://foundries.io/categories/news-and-media>news-and-media (6)</a></li><li><a href=https://foundries.io/categories/updates>updates (46)</a></li><li><a href=https://foundries.io/categories/zephyr-mp>zephyr-mp (2)</a></li><li><a href=https://foundries.io/categories/zephyr-news>zephyr-news (16)</a></li></ul></div></div><div class="panel sidebar-menu"><div class=panel-heading><h3 class=panel-title>Tags</h3></div><div class=panel-body><ul class=tag-cloud><li><a href=https://foundries.io/tags/ai><i class="fa fa-tags"></i>ai</a></li><li><a href=https://foundries.io/tags/assistant><i class="fa fa-tags"></i>assistant</a></li><li><a href=https://foundries.io/tags/att><i class="fa fa-tags"></i>att</a></li><li><a href=https://foundries.io/tags/ble><i class="fa fa-tags"></i>ble</a></li><li><a href=https://foundries.io/tags/blockchain><i class="fa fa-tags"></i>blockchain</a></li><li><a href=https://foundries.io/tags/bugs><i class="fa fa-tags"></i>bugs</a></li><li><a href=https://foundries.io/tags/container><i class="fa fa-tags"></i>container</a></li><li><a href=https://foundries.io/tags/containers><i class="fa fa-tags"></i>containers</a></li><li><a href=https://foundries.io/tags/crypto><i class="fa fa-tags"></i>crypto</a></li><li><a href=https://foundries.io/tags/cve><i class="fa fa-tags"></i>cve</a></li><li><a href=https://foundries.io/tags/decentralized><i class="fa fa-tags"></i>decentralized</a></li><li><a href=https://foundries.io/tags/demos><i class="fa fa-tags"></i>demos</a></li><li><a href=https://foundries.io/tags/docker><i class="fa fa-tags"></i>docker</a></li><li><a href=https://foundries.io/tags/docker-compose><i class="fa fa-tags"></i>docker-compose</a></li><li><a href=https://foundries.io/tags/edge><i class="fa fa-tags"></i>edge</a></li><li><a href=https://foundries.io/tags/fota><i class="fa fa-tags"></i>fota</a></li><li><a href=https://foundries.io/tags/foundries.io><i class="fa fa-tags"></i>foundries.io</a></li><li><a href=https://foundries.io/tags/google><i class="fa fa-tags"></i>google</a></li><li><a href=https://foundries.io/tags/iot><i class="fa fa-tags"></i>iot</a></li><li><a href=https://foundries.io/tags/k8s><i class="fa fa-tags"></i>k8s</a></li><li><a href=https://foundries.io/tags/kernel><i class="fa fa-tags"></i>kernel</a></li><li><a href=https://foundries.io/tags/keys><i class="fa fa-tags"></i>keys</a></li><li><a href=https://foundries.io/tags/kubernetes><i class="fa fa-tags"></i>kubernetes</a></li><li><a href=https://foundries.io/tags/linux><i class="fa fa-tags"></i>linux</a></li><li><a href=https://foundries.io/tags/lmp><i class="fa fa-tags"></i>lmp</a></li><li><a href=https://foundries.io/tags/lte><i class="fa fa-tags"></i>lte</a></li><li><a href=https://foundries.io/tags/lts><i class="fa fa-tags"></i>lts</a></li><li><a href=https://foundries.io/tags/lwm2m><i class="fa fa-tags"></i>lwm2m</a></li><li><a href=https://foundries.io/tags/management><i class="fa fa-tags"></i>management</a></li><li><a href=https://foundries.io/tags/mcuboot><i class="fa fa-tags"></i>mcuboot</a></li><li><a href=https://foundries.io/tags/media><i class="fa fa-tags"></i>media</a></li><li><a href=https://foundries.io/tags/microplatform><i class="fa fa-tags"></i>microplatform</a></li><li><a href=https://foundries.io/tags/open-source><i class="fa fa-tags"></i>open-source</a></li><li><a href=https://foundries.io/tags/ota><i class="fa fa-tags"></i>ota</a></li><li><a href=https://foundries.io/tags/portainer><i class="fa fa-tags"></i>portainer</a></li><li><a href=https://foundries.io/tags/press><i class="fa fa-tags"></i>press</a></li><li><a href=https://foundries.io/tags/radio><i class="fa fa-tags"></i>radio</a></li><li><a href=https://foundries.io/tags/resin><i class="fa fa-tags"></i>resin</a></li><li><a href=https://foundries.io/tags/security><i class="fa fa-tags"></i>security</a></li><li><a href=https://foundries.io/tags/update><i class="fa fa-tags"></i>update</a></li><li><a href=https://foundries.io/tags/whitepaper><i class="fa fa-tags"></i>whitepaper</a></li><li><a href=https://foundries.io/tags/zephyr><i class="fa fa-tags"></i>zephyr</a></li><li><a href=https://foundries.io/tags/zmp><i class="fa fa-tags"></i>zmp</a></li></ul></div></div></div></div></div></div></div><footer><div class=row><div class="columns small-12 medium-6"><div class=contacts><i class="fa fa-map-marker"></i>CAMBRIDGE, UK</div></div><div class="columns small-12 medium-6"><div class=contacts><i class="fa fa-map-marker"></i>SEATTLE, WA USA</div></div></div><div class="row footerlinks"><div class="columns small-12 medium-3 border-right"><h2>About Foundries.io</h2><p>Foundries.io is changing the IoT landscape by delivering continuously
updated software platforms for a secure, connected world.</p></div><div class="columns small-12 medium-3 border-right"><h2>Company</h2><ul><li><a href=https://foundries.io/company/>About</a></li><li><a href=https://foundries.io/careers/>Careers</a></li><li><a href=https://support.foundries.io/>Support</a></li><li><a href=https://foundries.io/labs/>Labs</a></li></ul></div><div class="columns small-12 medium-3 border-right"><h2>Connect</h2><ul class=social-links><li><a href=https://twitter.com/foundriesio><i class="fa fa-twitter fa-2x"></i></a></li><li><a href=https://www.linkedin.com/company/foundriesio/><i class="fa fa-linkedin fa-2x"></i></a></li><li><a href=https://github.com/foundriesio><i class="fa fa-github fa-2x"></i></a></li><li><a href=https://join.slack.com/t/foundriesio/shared_invite/enQtNTc5NDkxNTI5NTExLTU1YzI3YWFmZTI3ZjRjOTExZDZjYWFmMDNjZDBjYjczYTYzZWE0ZWYxYWVjMGZhYjNjN2MyMDVhMzY5NWNlNDE><i class="fa fa-slack fa-2x"></i></a></li></ul></div><div class="columns small-12 medium-3"><h2>Get Started Today</h2><p>Get immediate access to microPlatform source and binary builds for
today's most popular development boards by starting your subscription.</p></div></div><p class=copyright>Copyright 2018 &ndash; 2019 Foundries.io All rights reserved</p></footer><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-111281311-1','auto');ga('send','pageview');}</script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin=anonymous></script><script src=/js/vendor/wow.min.js></script><script src=/js/vendor/what-input.min.js></script><script src=/js/vendor/hoverIntent.js></script><script src=/js/vendor/jquery.responsiveTabs.js></script><script src=/js/vendor/superfish.min.js></script><script src=/js/vendor/owl.carousel.min.js></script><script src=/js/vendor/foundation.min.js></script><script src=/js/custom.min.js></script></body></html>